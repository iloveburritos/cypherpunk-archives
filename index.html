<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cypherpunk Archives</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f6f8fc;
            color: #202124;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 256px;
            padding-left: 4px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
        }

        .logo-icon svg {
            width: 100%;
            height: 100%;
        }

        .logo-text {
            font-family: 'Google Sans', sans-serif;
            font-size: 22px;
            color: #5f6368;
            white-space: nowrap;
        }

        .search-container {
            flex: 1;
            max-width: 720px;
            margin: 0 auto;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #eaf1fb;
            border-radius: 24px;
            padding: 0 16px;
            height: 48px;
            transition: background 0.2s, box-shadow 0.2s;
        }

        .search-box:focus-within {
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }

        .search-icon {
            color: #5f6368;
            margin-right: 12px;
            font-size: 20px;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            outline: none;
            color: #202124;
        }

        .search-box input::placeholder {
            color: #5f6368;
        }

        /* Layout */
        .layout {
            display: flex;
            padding-top: 64px;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 256px;
            padding: 8px 0;
            position: fixed;
            top: 64px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            background: #f6f8fc;
        }

        /* Nav items */
        .nav-item {
            display: flex;
            align-items: center;
            padding: 6px 24px 6px 12px;
            margin: 2px 8px;
            border-radius: 0 16px 16px 0;
            cursor: pointer;
            transition: background 0.1s;
            gap: 12px;
            font-size: 14px;
            color: #202124;
        }

        .nav-item:hover {
            background: #e8eaed;
        }

        .nav-item.active {
            background: #d3e3fd;
            font-weight: 500;
        }

        .nav-icon {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .nav-count {
            margin-left: auto;
            font-size: 12px;
            color: #5f6368;
        }

        .nav-item.active .nav-count {
            color: #001d35;
        }

        .info-btn {
            min-width: 18px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid #dadce0;
            color: #5f6368;
            font-size: 10px;
            font-weight: normal;
            font-style: normal;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: -8px;
            position: relative;
            flex-shrink: 0;
            line-height: 1;
        }

        .info-btn:hover {
            background: #fff;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        .info-tooltip {
            display: none;
            position: fixed;
            left: 270px;
            top: 85px;
            background: #fff;
            color: #3c4043;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: normal;
            font-style: normal;
            line-height: 1.5;
            width: 280px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #dadce0;
        }

        .info-tooltip-title {
            color: #1a73e8;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .info-btn:hover .info-tooltip {
            display: block;
        }

        .labels-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 8px 16px;
        }

        .sidebar-section {
            padding: 8px 12px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 500;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            margin-top: 8px;
        }

        .person-list {
            list-style: none;
        }

        .person-item {
            display: flex;
            align-items: center;
            padding: 8px 16px 8px 16px;
            margin: 1px 8px;
            border-radius: 0 16px 16px 0;
            cursor: pointer;
            transition: background 0.1s;
            gap: 12px;
        }

        .person-item:hover {
            background: #e8eaed;
        }

        .person-item.active {
            background: #d3e3fd;
            color: #001d35;
        }

        .person-name {
            font-size: 14px;
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
            line-height: 1;
        }

        .person-count {
            font-size: 14px;
            color: #5f6368;
            flex-shrink: 0;
            line-height: 1;
        }

        .person-item.active .person-count {
            color: #001d35;
        }

        .person-info-btn {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid #dadce0;
            color: #5f6368;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .person-item:hover .person-info-btn {
            opacity: 1;
        }

        .person-info-btn:hover {
            background: #fff;
            border-color: #1a73e8;
            color: #1a73e8;
        }


        /* Main content */
        .main-content {
            flex: 1;
            margin-left: 256px;
            padding: 0;
            background: #fff;
            height: calc(100vh - 64px);
            border-radius: 16px 0 0 0;
            overflow-y: auto;
        }

        .label-icon {
            width: 20px;
            height: 14px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .label-icon svg {
            width: 20px;
            height: 14px;
            display: block;
        }

        /* Thread list */
        .thread-list-view {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .thread-list-container {
            padding: 0;
        }

        .thread-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
        }

        .list-header {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid #e0e0e0;
            gap: 16px;
        }

        .list-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: #5f6368;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
        }

        .action-btn:hover {
            background: #f1f3f4;
        }

        .list-info {
            flex: 1;
            text-align: right;
            color: #5f6368;
            font-size: 13px;
        }

        .filter-controls {
            display: flex;
            gap: 12px;
            padding: 8px 16px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .filter-select {
            padding: 6px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            background: #fff;
            font-size: 13px;
            color: #3c4043;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #1a73e8;
        }

        /* Thread rows */
        .thread-row {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background 0.1s;
        }

        .thread-row:hover {
            background: #f5f5f5;
            box-shadow: inset 3px 0 0 #1a73e8;
        }

        .thread-row.unread {
            background: #fff;
        }

        .thread-row.unread .thread-sender,
        .thread-row.unread .thread-subject {
            font-weight: 500;
        }

        .thread-sender {
            width: 200px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #202124;
            flex-shrink: 0;
        }

        .sender-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thread-count {
            font-size: 12px;
            color: #5f6368;
            flex-shrink: 0;
        }

        .thread-content {
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 32px;
        }

        .thread-subject {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
        }

        .thread-snippet {
            color: #9aa0a6;
            font-size: 14px;
            font-weight: 400;
        }

        .thread-date {
            font-size: 12px;
            color: #5f6368;
            white-space: nowrap;
            flex-shrink: 0;
            margin-left: auto;
        }

        .notable-badge {
            font-size: 10px;
            color: #1a73e8;
            background: #e8f0fe;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 8px 16px;
            gap: 8px;
            border-top: 1px solid #e0e0e0;
        }

        .pagination-info {
            font-size: 13px;
            color: #5f6368;
            margin-right: 16px;
        }

        .pagination-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #5f6368;
            cursor: pointer;
            border-radius: 50%;
            font-size: 18px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f1f3f4;
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Thread detail view */
        .thread-detail {
            display: none;
            padding: 0;
        }

        .thread-detail.active {
            display: block;
        }

        .thread-list-view.hidden {
            display: none;
        }

        .detail-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #5f6368;
            cursor: pointer;
            border-radius: 50%;
            font-size: 20px;
            flex-shrink: 0;
        }

        .back-btn:hover {
            background: #f1f3f4;
        }

        .detail-title {
            flex: 1;
        }

        .detail-title h1 {
            font-size: 22px;
            font-weight: 400;
            color: #202124;
            margin-bottom: 4px;
        }

        .detail-meta {
            font-size: 13px;
            color: #5f6368;
        }

        .detail-actions {
            display: none;
            gap: 8px;
            margin-left: auto;
        }

        .detail-actions.visible {
            display: flex;
        }

        .detail-action-btn {
            padding: 8px 16px;
            border: 1px solid #dadce0;
            background: #fff;
            color: #5f6368;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.1s, border-color 0.1s;
        }

        .detail-action-btn:hover {
            background: #f1f3f4;
            border-color: #5f6368;
        }

        .thread-nav {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 16px;
        }

        .thread-nav-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #5f6368;
            cursor: pointer;
            border-radius: 50%;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thread-nav-btn:hover:not(:disabled) {
            background: #f1f3f4;
        }

        .thread-nav-btn:disabled {
            color: #dadce0;
            cursor: default;
        }

        .thread-nav-info {
            font-size: 12px;
            color: #5f6368;
            min-width: 60px;
            text-align: center;
        }

        /* Email messages */
        .email-list {
            padding: 0 24px 24px;
        }

        .email-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 8px;
            overflow: hidden;
        }

        .email-card.notable {
            border-color: #1a73e8;
        }

        .email-card.collapsed {
            cursor: pointer;
        }

        .email-card.collapsed:hover {
            background: #f5f5f5;
        }

        .email-card.collapsed .email-body,
        .email-card.collapsed .expand-btn,
        .email-card.collapsed .email-to {
            display: none;
        }

        .email-card-header {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            background: #f8f9fa;
            gap: 12px;
        }

        .email-card.collapsed .email-card-header {
            background: transparent;
            padding: 12px 16px;
            align-items: center;
        }

        .email-card.notable .email-card-header {
            background: #e8f0fe;
        }

        .email-card.collapsed.notable .email-card-header {
            background: transparent;
        }

        .email-snippet {
            display: none;
            color: #5f6368;
            font-size: 14px;
            font-weight: 400;
            margin-left: 4px;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .email-card.collapsed .email-snippet {
            display: inline;
        }

        .email-card.collapsed .email-header-content {
            flex: 1;
            display: flex;
            align-items: center;
            min-width: 0;
        }

        .email-card.collapsed .email-from {
            flex-shrink: 0;
        }

        .email-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1a73e8;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .email-header-content {
            flex: 1;
            min-width: 0;
        }

        .email-from {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
        }

        .sender-link {
            cursor: pointer;
        }

        .sender-link:hover {
            color: #1a73e8;
        }

        .email-address {
            font-weight: 400;
            color: #5f6368;
            margin-left: 4px;
            cursor: pointer;
        }

        .email-address:hover {
            color: #1a73e8;
            text-decoration: underline;
        }

        .email-from .notable-tag {
            font-size: 11px;
            font-weight: 400;
            color: #1a73e8;
            background: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            border: 1px solid #1a73e8;
        }

        .email-to {
            font-size: 12px;
            color: #5f6368;
            margin-top: 2px;
        }

        .email-date {
            font-size: 12px;
            color: #5f6368;
            white-space: nowrap;
        }

        .email-body {
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: #202124;
            white-space: pre-wrap;
            font-family: 'Roboto', sans-serif;
            max-height: 400px;
            overflow-y: auto;
        }

        .email-body.collapsed {
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .email-body.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, white);
        }

        .expand-btn {
            display: block;
            width: 100%;
            padding: 8px;
            border: none;
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
            color: #1a73e8;
            font-size: 13px;
            cursor: pointer;
        }

        .expand-btn:hover {
            background: #e8f0fe;
        }

        /* Bio tooltip */
        .bio-tooltip {
            display: none;
            position: fixed;
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            max-width: 320px;
            font-size: 13px;
            color: #202124;
            line-height: 1.5;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .bio-tooltip.visible {
            display: block;
        }

        .bio-tooltip .bio-name {
            font-weight: 500;
            color: #1a73e8;
            margin-bottom: 8px;
        }

        .bio-tooltip .bio-text {
            color: #5f6368;
        }

        /* Active filter display */
        .active-filter {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #e8f0fe;
            border-bottom: 1px solid #d3e3fd;
        }

        .active-filter.visible {
            display: flex;
        }

        .active-filter-text {
            font-size: 13px;
            color: #1a73e8;
        }

        .active-filter-clear {
            padding: 4px 8px;
            border: none;
            background: transparent;
            color: #1a73e8;
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 48px;
            color: #5f6368;
        }

        /* Welcome popup */
        .welcome-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .welcome-overlay.visible {
            display: flex;
        }

        .welcome-popup {
            background: #fff;
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .welcome-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }

        .welcome-icon svg {
            width: 100%;
            height: 100%;
        }

        .welcome-popup h2 {
            font-family: 'Google Sans', sans-serif;
            font-size: 24px;
            font-weight: 500;
            color: #202124;
            margin: 0 0 16px;
        }

        .welcome-popup p {
            font-size: 15px;
            line-height: 1.6;
            color: #5f6368;
            margin: 0 0 12px;
        }

        .welcome-hint {
            color: #3c4043;
            margin-top: 16px;
        }

        .welcome-hint strong {
            color: #1a73e8;
        }

        .welcome-btn {
            margin-top: 24px;
            padding: 12px 32px;
            background: #1a73e8;
            color: #fff;
            border: none;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .welcome-btn:hover {
            background: #1557b0;
        }

        @media (max-width: 480px) {
            .welcome-popup {
                padding: 24px;
            }

            .welcome-popup h2 {
                font-size: 20px;
            }

            .welcome-popup p {
                font-size: 14px;
            }
        }

        /* Mobile menu toggle button */
        .mobile-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #5f6368;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }

        .mobile-menu-btn:hover {
            background: #f1f3f4;
        }

        /* Mobile nav tabs (shown at top on mobile) */
        .mobile-nav {
            display: none;
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 16px;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            z-index: 50;
        }

        /* Hide sidebar close button on desktop */
        .sidebar-close-btn {
            display: none;
        }

        .mobile-nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            background: #f1f3f4;
            color: #5f6368;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            border: none;
            flex-shrink: 0;
        }

        .mobile-nav-item.active {
            background: #d3e3fd;
            color: #001d35;
        }

        .mobile-nav-item:hover {
            background: #e8eaed;
        }

        .mobile-nav-item.active:hover {
            background: #c2d8f8;
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
        }

        .sidebar-overlay.visible {
            display: block;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .mobile-menu-btn {
                display: flex;
            }

            .mobile-nav {
                display: flex;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                height: 100vh;
                z-index: 200;
                background: #fff;
                transition: left 0.3s ease;
                padding-top: 16px;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-close-btn {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 8px 16px 16px;
                border-bottom: 1px solid #e0e0e0;
                margin-bottom: 8px;
            }

            .sidebar-close-btn span {
                font-size: 18px;
                font-weight: 500;
                color: #202124;
            }

            .sidebar-close-btn button {
                width: 36px;
                height: 36px;
                border: none;
                background: transparent;
                color: #5f6368;
                cursor: pointer;
                border-radius: 50%;
                font-size: 20px;
            }

            .sidebar-close-btn button:hover {
                background: #f1f3f4;
            }

            .main-content {
                margin-left: 0;
                border-radius: 0;
                height: calc(100vh - 116px); /* Account for header + mobile nav */
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .layout {
                padding-top: 116px; /* 64px header + 52px mobile nav */
                height: 100vh;
                overflow: hidden;
            }

            .thread-detail {
                height: 100%;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .email-list {
                padding-bottom: 100px; /* Extra padding at bottom for easier scrolling */
            }

            .sidebar-close-btn {
                display: flex;
            }

            .logo {
                width: auto;
            }

            .logo-text {
                display: none;
            }

            .search-container {
                margin-left: 0;
            }

            .thread-sender {
                width: 100px;
            }

            .thread-count {
                display: none;
            }

            .thread-content {
                margin-right: 8px;
            }

            .thread-snippet {
                display: none;
            }

            .thread-date {
                font-size: 11px;
            }

            .detail-header {
                padding: 12px 16px;
                flex-wrap: wrap;
            }

            .detail-title h1 {
                font-size: 18px;
            }

            .thread-nav {
                margin-left: 0;
                margin-top: 8px;
                width: 100%;
                justify-content: center;
            }

            .email-list {
                padding: 0 12px 12px;
            }

            .email-card-header {
                padding: 12px;
                flex-wrap: wrap;
            }

            .email-card.collapsed .email-card-header {
                flex-wrap: nowrap;
            }

            .email-card.collapsed .email-header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
            }

            .email-card.collapsed .email-header-content {
                flex: 1;
                min-width: 0;
                overflow: hidden;
            }

            .email-card.collapsed .email-from {
                display: block;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                max-width: calc(100% - 10px);
            }

            .email-card.collapsed .email-from .sender-link {
                font-weight: 500;
            }

            .email-card.collapsed .email-from .email-address {
                display: none;
            }

            .email-card.collapsed .email-snippet {
                display: none;
            }

            .email-card.collapsed .email-date {
                flex-shrink: 0;
                margin-left: 8px;
                white-space: nowrap;
            }

            /* Expanded email card on mobile */
            .email-card:not(.collapsed) .email-header-content {
                flex: 1;
                min-width: 0;
            }

            .email-card:not(.collapsed) .email-from {
                display: block;
            }

            .email-card:not(.collapsed) .email-from .sender-link {
                display: block;
                font-weight: 500;
                margin-bottom: 2px;
            }

            .email-card:not(.collapsed) .email-from .email-address {
                display: block;
                font-size: 12px;
                margin-left: 0;
                color: #5f6368;
            }

            .email-card:not(.collapsed) .email-date {
                position: absolute;
                top: 12px;
                right: 12px;
                font-size: 10px;
            }

            .email-card:not(.collapsed) .email-card-header {
                position: relative;
            }

            .email-card:not(.collapsed) .email-header-content {
                padding-right: 90px;
            }

            .email-body {
                padding: 12px;
            }

            .filter-controls {
                padding: 8px 12px;
            }

            .info-tooltip {
                left: 16px !important;
                right: 16px;
                width: auto;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 8px;
            }

            .search-box {
                height: 40px;
                padding: 0 12px;
            }

            .search-box input {
                font-size: 14px;
            }

            .thread-sender {
                width: 80px;
                font-size: 13px;
            }

            .thread-subject {
                font-size: 13px;
            }

            .thread-row {
                padding: 8px 12px;
            }

            .pagination {
                padding: 8px 12px;
            }

            .detail-actions {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Open menu">‚ò∞</button>
        <div class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C9.24 2 7 4.24 7 7V10H6C4.9 10 4 10.9 4 12V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V12C20 10.9 19.1 10 18 10H17V7C17 4.24 14.76 2 12 2ZM9 7C9 5.34 10.34 4 12 4C13.66 4 15 5.34 15 7V10H9V7Z" fill="#00ff41"/>
                    <circle cx="12" cy="16" r="2" fill="#1a1a2e"/>
                </svg>
            </div>
            <div class="logo-text">Cypherpunk Archives</div>
        </div>
        <div class="search-container">
            <div class="search-box">
                <span class="search-icon">&#128269;</span>
                <input type="text" id="search-input" placeholder="Search mail">
            </div>
        </div>
    </header>

    <!-- Mobile navigation tabs -->
    <nav class="mobile-nav" id="mobile-nav">
        <button class="mobile-nav-item active" id="mobile-nav-important" data-view="important">
            <span>‚≠ê</span> Important
        </button>
        <button class="mobile-nav-item" id="mobile-nav-all" data-view="all">
            <span>üìß</span> All Mail
        </button>
        <button class="mobile-nav-item" id="mobile-nav-labels">
            <span>üè∑Ô∏è</span> Labels
        </button>
    </nav>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-close-btn" id="sidebar-close">
                <span>Labels</span>
                <button aria-label="Close menu">‚úï</button>
            </div>
            <div class="sidebar-section">
                <div class="nav-item active" id="nav-important" data-view="important">
                    <span class="nav-icon">‚≠ê</span>
                    <span>Important</span>
                    <span class="info-btn">i<span class="info-tooltip"><div class="info-tooltip-title">Important</div>A curated selection of the most influential cypherpunk emails. A great starting point for first-time visitors.</span></span>
                    <span class="nav-count" id="important-count">-</span>
                </div>
                <div class="nav-item" id="nav-all" data-view="all">
                    <span class="nav-icon">üìß</span>
                    <span>All Mail</span>
                    <span class="nav-count" id="all-count">-</span>
                </div>
            </div>
            <div class="labels-divider"></div>
            <div class="sidebar-title">Labels</div>
            <ul class="person-list" id="person-list">
                <li class="loading">Loading...</li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="active-filter" id="active-filter">
                <span class="active-filter-text" id="active-filter-text"></span>
                <button class="active-filter-clear" id="active-filter-clear">Clear filter</button>
            </div>

            <div class="thread-list-view" id="thread-list-view">
                <div class="filter-controls">
                    <select class="filter-select" id="year-filter">
                        <option value="">All Years</option>
                        <option value="1992">1992</option>
                        <option value="1993">1993</option>
                        <option value="1994">1994</option>
                        <option value="1995">1995</option>
                        <option value="1996">1996</option>
                        <option value="1997">1997</option>
                        <option value="1998">1998</option>
                        <option value="1999">1999</option>
                    </select>
                    <select class="filter-select" id="sort-order">
                        <option value="date-asc">Oldest First</option>
                        <option value="date-desc">Newest First</option>
                        <option value="size-desc">Most Messages</option>
                        <option value="size-asc">Fewest Messages</option>
                    </select>
                </div>

                <div class="list-header">
                    <div class="list-info" id="list-info">Loading...</div>
                </div>

                <ul class="thread-list" id="thread-list">
                    <li class="loading">Loading archive...</li>
                </ul>

                <div class="pagination">
                    <span class="pagination-info" id="pagination-info"></span>
                    <button class="pagination-btn" id="prev-btn" disabled>&#8249;</button>
                    <button class="pagination-btn" id="next-btn">&#8250;</button>
                </div>
            </div>

            <div class="thread-detail" id="thread-detail">
                <div class="detail-header">
                    <button class="back-btn" id="back-btn">&#8592;</button>
                    <div class="detail-title">
                        <h1 id="detail-subject"></h1>
                        <div class="detail-meta" id="detail-meta"></div>
                    </div>
                    <div class="detail-actions" id="detail-actions">
                        <button class="detail-action-btn" id="expand-all-btn">Expand all</button>
                        <button class="detail-action-btn" id="collapse-all-btn">Collapse all</button>
                    </div>
                    <div class="thread-nav">
                        <button class="thread-nav-btn" id="prev-thread-btn" title="Previous thread (k)">&#8249;</button>
                        <span class="thread-nav-info" id="thread-nav-info"></span>
                        <button class="thread-nav-btn" id="next-thread-btn" title="Next thread (j)">&#8250;</button>
                    </div>
                </div>
                <div class="email-list" id="email-list"></div>
            </div>
        </main>
    </div>

    <div class="bio-tooltip" id="bio-tooltip">
        <div class="bio-name" id="bio-name"></div>
        <div class="bio-text" id="bio-text"></div>
    </div>

    <!-- Welcome popup -->
    <div class="welcome-overlay" id="welcome-overlay">
        <div class="welcome-popup">
            <div class="welcome-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C9.24 2 7 4.24 7 7V10H6C4.9 10 4 10.9 4 12V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V12C20 10.9 19.1 10 18 10H17V7C17 4.24 14.76 2 12 2ZM9 7C9 5.34 10.34 4 12 4C13.66 4 15 5.34 15 7V10H9V7Z" fill="#00ff41"/>
                    <circle cx="12" cy="16" r="2" fill="#1a1a2e"/>
                </svg>
            </div>
            <h2>Welcome to the Cypherpunk Archives</h2>
            <p>A searchable archive of the Cypherpunks mailing list (1992‚Äì1999) ‚Äî where the ideas behind digital privacy, anonymous communication, and cryptocurrency were first debated.</p>
            <p class="welcome-hint">Start with <strong>Important</strong> for curated highlights, or explore <strong>All Mail</strong> to dig into 97,000+ messages.</p>
            <button class="welcome-btn" id="welcome-btn">Enter the Archives</button>
        </div>
    </div>

    <script>
        // State
        let notableThreads = [];
        let allThreads = [];
        let starredThreads = [];
        let threads = [];
        let emails = {};
        let allEmails = {};
        let notableAuthors = {};
        let notableStats = {};
        let starredData = {};
        let filteredThreads = [];
        let currentPage = 1;
        let selectedPerson = null;
        let currentView = 'important'; // 'important', 'all', or 'starred'
        let currentThreadIndex = -1; // Track current thread position in filteredThreads
        const perPage = 50;

        // Build reverse lookup: email -> person name
        let emailToPerson = {};

        // Bios for notable cypherpunks
        const personBios = {
            "Timothy C. May": "Co-founder of the Cypherpunks; author of The Crypto Anarchist Manifesto, shaping the modern privacy-through-cryptography ethos.",
            "Perry E. Metzger": "Founder of the Cypherpunks mailing list; drove practical deployment of strong cryptography and anti-surveillance activism.",
            "Jim Bell": "Radical cypherpunk economist known for \"Assassination Politics,\" exploring cryptographically-enabled market anonymity.",
            "Eric Hughes": "Author of A Cypherpunk's Manifesto and co-founder of the movement; champion of anonymous digital identity.",
            "Duncan Frissell": "Libertarian writer and cypherpunk advocate focused on digital rights, privacy law, and crypto-backed civil liberties.",
            "Black Unicorn": "Pseudonymous cryptography expert known for sharp, technical privacy analysis within the early cypherpunk community.",
            "Lucky Green": "Operator of early remailer and anonymity infrastructure; contributor to PGP and digital privacy systems.",
            "Adam Back": "Inventor of Hashcash (Bitcoin's PoW precursor); long-time cypherpunk driving anonymous e-cash and privacy tech.",
            "James A. Donald": "Early Bitcoin discussant and cryptography commentator known for critiques of privacy protocols and scaling.",
            "Hal Finney": "Legendary cryptographer; creator of PGP 2.0, reusable proofs of work, and first recipient of a Bitcoin transaction.",
            "John Gilmore": "EFF co-founder and early cypherpunk pushing strong crypto export freedom and anonymous networks.",
            "Carl Ellison": "Pioneer in public-key infrastructure and digital certificates; contributor to SPKI and secure identity protocols.",
            "Phil Karn": "Engineer who helped liberalize US crypto-export laws by challenging restrictions on privacy tech.",
            "Rishab Aiyer Ghosh": "Researcher mapping open-source ecosystems and digital freedom economics tied to privacy online.",
            "Bryce 'Zooko' Wilcox": "Creator of Zcash; long-time privacy technologist known for naming Zooko's Triangle (identity properties).",
            "Lance Cottrell": "Founder of Anonymizer.com; built one of the earliest commercial privacy and anonymous browsing services.",
            "Matt Blaze": "Cryptographer who exposed Clipper Chip vulnerabilities; major critic of government backdoors in privacy tech.",
            "Ian Goldberg": "Designer of Off-the-Record (OTR) Messaging; Tor Project contributor and world-class privacy cryptographer.",
            "Wei Dai": "Creator of b-money (a Bitcoin precursor) and contributor to anonymity, crypto protocols, and digital freedom theory.",
            "Johan Helsingius": "Operator of the world's most famous anonymous remailer, anon.penet.fi.",
            "Julian Assange": "Founder of WikiLeaks; cypherpunk veteran advocating radical transparency and individual anonymity.",
            "Eric Blossom": "Founder of GNU Radio; advocate for open, privacy-respecting communication systems.",
            "Nick Szabo": "Creator of smart contracts and Bit Gold; thinker bridging cryptography, digital privacy, and decentralized money.",
            "Vipul Ved Prakash": "Creator of Vipul's Razor anti-spam tool; early developer of cryptographically-driven information hygiene systems.",
            "Bruce Schneier": "World-renowned cryptographer and author who popularized privacy security practices and government backdoor critiques.",
            "Ryan Lackey": "Founder of HavenCo on Sealand; worked on secure hardware, private communications, and operational security systems.",
            "Philip Zimmermann": "Creator of PGP; central figure in the crypto-export \"Crypto Wars\" defending personal privacy rights.",
            "Marc Andreessen": "Co-author of Mosaic/Netscape; helped bring SSL and encrypted browsing to the mainstream Internet.",
            "Ian Grigg": "Architect of Ricardian Contracts and financial cryptography systems with strong privacy foundations.",
            "Whitfield Diffie": "Co-inventor of public-key cryptography; foundational figure enabling all modern privacy-preserving protocols.",
            "Bram Cohen": "Creator of BitTorrent; transformed peer-to-peer sharing with decentralized, censorship-resistant distribution.",
            "Mitch Kapor": "EFF co-founder and early Internet-rights funder supporting privacy and anti-surveillance advocacy.",
            "John Perry Barlow": "EFF co-founder; wrote \"A Declaration of the Independence of Cyberspace,\" defending digital freedom and anonymity.",
            "Martin Hellman": "Co-inventor of Diffie-Hellman key exchange, enabling private communication over insecure networks."
        };

        // Avatar colors
        const avatarColors = [
            '#1a73e8', '#ea4335', '#34a853', '#fbbc04', '#ff6d01',
            '#46bdc6', '#7baaf7', '#ee675c', '#f439a0', '#a142f4'
        ];

        function getAvatarColor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return avatarColors[Math.abs(hash) % avatarColors.length];
        }

        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(/[\s@<>]+/).filter(p => p);
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        // DOM Elements
        const threadListEl = document.getElementById('thread-list');
        const threadListView = document.getElementById('thread-list-view');
        const threadDetail = document.getElementById('thread-detail');
        const searchInput = document.getElementById('search-input');
        const yearFilter = document.getElementById('year-filter');
        const sortOrder = document.getElementById('sort-order');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const backBtn = document.getElementById('back-btn');
        const personListEl = document.getElementById('person-list');
        const activeFilter = document.getElementById('active-filter');
        const activeFilterText = document.getElementById('active-filter-text');
        const activeFilterClear = document.getElementById('active-filter-clear');
        const listInfo = document.getElementById('list-info');
        const paginationInfo = document.getElementById('pagination-info');
        const navImportant = document.getElementById('nav-important');
        const navAll = document.getElementById('nav-all');
        const importantCount = document.getElementById('important-count');
        const allCount = document.getElementById('all-count');
        const detailActions = document.getElementById('detail-actions');
        const expandAllBtn = document.getElementById('expand-all-btn');
        const collapseAllBtn = document.getElementById('collapse-all-btn');
        const prevThreadBtn = document.getElementById('prev-thread-btn');
        const nextThreadBtn = document.getElementById('next-thread-btn');
        const threadNavInfo = document.getElementById('thread-nav-info');

        // Load data
        // Track which year chunks have been loaded (for notable emails)
        const loadedNotableYears = new Set();
        const loadedAllMailYears = new Set();
        const emailYears = [1992, 1993, 1994, 1995, 1996, 1997, 1998];

        async function loadNotableEmailsForYear(year) {
            if (loadedNotableYears.has(year)) return;
            try {
                const resp = await fetch(`./notable/emails/emails_${year}.json`);
                const yearEmails = await resp.json();
                yearEmails.forEach(e => emails[e.id] = e);
                loadedNotableYears.add(year);
            } catch (err) {
                console.warn(`Could not load notable emails for ${year}:`, err);
            }
        }

        async function loadAllMailEmailsForYear(year) {
            if (loadedAllMailYears.has(year)) return;
            try {
                const resp = await fetch(`./final/emails/emails_${year}.json`);
                const yearEmails = await resp.json();
                yearEmails.forEach(e => allEmails[e.id] = e);
                loadedAllMailYears.add(year);
            } catch (err) {
                console.warn(`Could not load all mail emails for ${year}:`, err);
            }
        }

        async function loadAllNotableEmails() {
            await Promise.all(emailYears.map(loadNotableEmailsForYear));
        }

        async function loadAllMailEmails() {
            await Promise.all(emailYears.map(loadAllMailEmailsForYear));
        }

        async function loadData() {
            try {
                // First load notable data (for Important view) - small files only
                const [authorsResp, statsResp, notableThreadsResp, starredResp] = await Promise.all([
                    fetch('./notable/notable_authors.json'),
                    fetch('./notable/stats.json'),
                    fetch('./notable/threads.json'),
                    fetch('./notable/notable_emails_curated.json')
                ]);

                notableAuthors = await authorsResp.json();
                notableStats = await statsResp.json();
                notableThreads = await notableThreadsResp.json();
                starredData = await starredResp.json();

                emails = {};

                // Build starred threads list (this becomes Important)
                const starredThreadIds = new Set(starredData.thread_ids || []);
                starredThreads = notableThreads.filter(t => starredThreadIds.has(t.id));

                // Build email to person lookup
                for (const [person, emailList] of Object.entries(notableAuthors)) {
                    for (const email of emailList) {
                        emailToPerson[email.toLowerCase()] = person;
                    }
                }

                // Set initial state to Important view (using starred threads)
                threads = starredThreads;
                importantCount.textContent = starredThreads.length.toLocaleString();

                renderPersonList();
                applyFilters();

                // Load emails in background (don't block initial render)
                loadAllEmails();

                // Load all threads in background for All Mail view
                loadAllMail();
            } catch (err) {
                threadListEl.innerHTML = `<li class="loading" style="color: #d93025;">Error loading data: ${err.message}</li>`;
            }
        }

        // Load all mail in background (threads only - emails loaded on demand)
        async function loadAllMail() {
            try {
                const allThreadsResp = await fetch('./final/threads.json');
                if (!allThreadsResp.ok) {
                    throw new Error(`HTTP ${allThreadsResp.status}: ${allThreadsResp.statusText}`);
                }
                const text = await allThreadsResp.text();
                if (text.startsWith('version https://git-lfs')) {
                    throw new Error('File is still an LFS pointer - please clear browser cache');
                }
                allThreads = JSON.parse(text);
                allCount.textContent = allThreads.length.toLocaleString();
                return true;
            } catch (err) {
                console.warn('Could not load all mail:', err);
                allCount.textContent = 'N/A';
                return false;
            }
        }

        // Render person list
        function renderPersonList() {
            const sortedPeople = Object.entries(notableStats.posts_by_person || {})
                .sort((a, b) => b[1] - a[1]);

            personListEl.innerHTML = sortedPeople.map(([name, postCount]) => {
                const threadCount = notableStats.threads_by_person?.[name] || 0;
                const color = getAvatarColor(name);
                return `
                    <li class="person-item" data-person="${escapeHtml(name)}">
                        <div class="label-icon">
                            <svg viewBox="0 0 24 18" fill="${color}">
                                <path d="M2 2 L2 16 Q2 17 3 17 L15 17 L22 9 L15 1 L3 1 Q2 1 2 2 Z"/>
                            </svg>
                        </div>
                        <span class="person-name">${escapeHtml(name)}</span>
                        ${personBios[name] ? `<button class="person-info-btn" data-person="${escapeHtml(name)}">i</button>` : ''}
                        <span class="person-count">${postCount.toLocaleString()}</span>
                    </li>
                `;
            }).join('');

            personListEl.querySelectorAll('.person-item').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target.classList.contains('info-btn')) return;
                    selectPerson(el.dataset.person);
                });
            });

            personListEl.querySelectorAll('.person-info-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showBioTooltip(btn.dataset.person, e);
                });
            });
        }

        // Bio tooltip
        const bioTooltip = document.getElementById('bio-tooltip');
        const bioNameEl = document.getElementById('bio-name');
        const bioTextEl = document.getElementById('bio-text');

        function showBioTooltip(personName, event) {
            const bio = personBios[personName];
            if (!bio) return;

            bioNameEl.textContent = personName;
            bioTextEl.textContent = bio;

            const rect = event.target.getBoundingClientRect();
            let left = rect.right + 10;
            let top = rect.top;

            if (left + 320 > window.innerWidth) {
                left = rect.left - 330;
            }
            if (top + 100 > window.innerHeight) {
                top = window.innerHeight - 120;
            }

            bioTooltip.style.left = left + 'px';
            bioTooltip.style.top = top + 'px';
            bioTooltip.classList.add('visible');

            setTimeout(() => {
                document.addEventListener('click', hideBioTooltip, { once: true });
            }, 0);
        }

        function hideBioTooltip() {
            bioTooltip.classList.remove('visible');
        }

        // Select person
        function selectPerson(personName) {
            selectedPerson = personName;
            searchInput.value = '';

            personListEl.querySelectorAll('.person-item').forEach(el => {
                el.classList.toggle('active', el.dataset.person === personName);
            });

            // Deselect nav items when a person is selected
            navImportant.classList.remove('active');
            navAll.classList.remove('active');

            // Use all notable threads when filtering by person (not just current view)
            threads = notableThreads;

            activeFilterText.textContent = `Showing threads with ${personName}`;
            activeFilter.classList.add('visible');

            threadDetail.classList.remove('active');
            threadListView.classList.remove('hidden');

            applyFilters();
            window.scrollTo(0, 0);
        }

        // Clear filter
        function clearFilter() {
            selectedPerson = null;
            searchInput.value = '';
            personListEl.querySelectorAll('.person-item').forEach(el => {
                el.classList.remove('active');
            });
            activeFilter.classList.remove('visible');

            // Re-select the current view nav item
            navImportant.classList.toggle('active', currentView === 'important');
            navAll.classList.toggle('active', currentView === 'all');

            threadDetail.classList.remove('active');
            threadListView.classList.remove('hidden');

            applyFilters();
            window.scrollTo(0, 0);
        }

        activeFilterClear.addEventListener('click', clearFilter);

        // Check if email belongs to a person
        function getPersonForEmail(emailAddr) {
            if (!emailAddr) return null;
            const normalized = emailAddr.toLowerCase().trim();
            if (emailToPerson[normalized]) return emailToPerson[normalized];
            for (const [pattern, person] of Object.entries(emailToPerson)) {
                if (normalized.includes(pattern)) return person;
            }
            return null;
        }

        // Check if thread contains person
        function threadContainsPerson(thread, personName) {
            const personEmails = notableAuthors[personName] || [];
            const normalizedEmails = personEmails.map(e => e.toLowerCase());
            return thread.participants.some(p => {
                const normalized = p.toLowerCase();
                return normalizedEmails.some(pe => normalized.includes(pe));
            });
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const year = yearFilter.value;
            const sort = sortOrder.value;

            filteredThreads = threads.filter(t => {
                if (selectedPerson && !threadContainsPerson(t, selectedPerson)) return false;

                if (searchTerm) {
                    const matchSubject = (t.subject || '').toLowerCase().includes(searchTerm);
                    const matchAuthor = (t.root_author || '').toLowerCase().includes(searchTerm);
                    const matchParticipants = (t.participants || []).some(p => p.toLowerCase().includes(searchTerm));
                    if (!matchSubject && !matchAuthor && !matchParticipants) return false;
                }

                if (year && String(t.year_start) !== year) return false;

                return true;
            });

            filteredThreads.sort((a, b) => {
                switch (sort) {
                    case 'date-desc': return (b.date_start || '').localeCompare(a.date_start || '');
                    case 'date-asc': return (a.date_start || '').localeCompare(b.date_start || '');
                    case 'size-desc': return b.message_count - a.message_count;
                    case 'size-asc': return a.message_count - b.message_count;
                }
            });

            currentPage = 1;
            renderThreadList();
        }

        // Render thread list
        function renderThreadList() {
            const totalPages = Math.ceil(filteredThreads.length / perPage);
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pageThreads = filteredThreads.slice(start, end);

            listInfo.textContent = `${filteredThreads.length.toLocaleString()} conversations`;
            paginationInfo.textContent = `${start + 1}-${Math.min(end, filteredThreads.length)} of ${filteredThreads.length}`;

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage >= totalPages;

            if (pageThreads.length === 0) {
                threadListEl.innerHTML = '<li class="loading">No threads match your filters</li>';
                return;
            }

            threadListEl.innerHTML = pageThreads.map(t => {
                const date = t.date_start ? formatDate(t.date_start) : '';
                const sender = t.root_author ? t.root_author.split('@')[0] : 'Unknown';
                const notablePeople = t.participants
                    .map(p => getPersonForEmail(p))
                    .filter(p => p);
                const uniqueNotable = [...new Set(notablePeople)];

                return `
                    <li class="thread-row" data-id="${t.id}">
                        <div class="thread-sender">
                            <span class="sender-name">${escapeHtml(sender)}</span>
                            ${t.message_count > 1 ? `<span class="thread-count">${t.message_count}</span>` : ''}
                        </div>
                        <div class="thread-content">
                            <span class="thread-subject">${escapeHtml(t.subject || '(No Subject)')}</span>
                            <span class="thread-snippet"> - ${escapeHtml(getThreadSnippet(t))}</span>
                        </div>
                        <span class="thread-date">${date}</span>
                    </li>
                `;
            }).join('');

            threadListEl.querySelectorAll('.thread-row').forEach(el => {
                el.addEventListener('click', () => showThread(el.dataset.id));
            });
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            if (date.getFullYear() === now.getFullYear()) {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function getThreadSnippet(thread) {
            // Try both email stores
            const firstEmail = emails[thread.message_ids[0]] || allEmails[thread.message_ids[0]];
            if (firstEmail && firstEmail.body) {
                return firstEmail.body.substring(0, 100).replace(/\s+/g, ' ');
            }
            return '';
        }

        // Show thread
        // Track if emails are fully loaded
        let notableEmailsLoaded = false;
        let allMailEmailsLoaded = false;

        const originalLoadAllNotableEmails = loadAllNotableEmails;
        loadAllNotableEmails = async function() {
            await originalLoadAllNotableEmails();
            notableEmailsLoaded = true;
        };

        const originalLoadAllMailEmails = loadAllMailEmails;
        loadAllMailEmails = async function() {
            await originalLoadAllMailEmails();
            allMailEmailsLoaded = true;
        };

        // Alias for backward compatibility
        const loadAllEmails = loadAllNotableEmails;

        async function showThread(threadId) {
            const thread = threads.find(t => t.id === threadId);
            if (!thread) return;

            // Track current position in filteredThreads for prev/next navigation
            currentThreadIndex = filteredThreads.findIndex(t => t.id === threadId);
            updateThreadNav();

            threadListView.classList.add('hidden');
            threadDetail.classList.add('active');

            document.getElementById('detail-subject').textContent = thread.subject || '(No Subject)';

            const dateRange = thread.date_start === thread.date_end
                ? formatDate(thread.date_start)
                : `${formatDate(thread.date_start)} - ${formatDate(thread.date_end)}`;

            document.getElementById('detail-meta').textContent =
                `${thread.message_count} message${thread.message_count !== 1 ? 's' : ''} ¬∑ ${dateRange}`;

            // Show expand/collapse buttons only for multi-message threads
            detailActions.classList.toggle('visible', thread.message_count > 1);

            // Determine which email store to use based on current view
            const isAllMailView = currentView === 'all';
            const emailStore = isAllMailView ? allEmails : emails;
            const emailsLoaded = isAllMailView ? allMailEmailsLoaded : notableEmailsLoaded;
            const loadEmailsFn = isAllMailView ? loadAllMailEmails : loadAllNotableEmails;

            // Check if emails are loaded, if not show loading and wait
            let threadEmails = thread.message_ids
                .map(id => emailStore[id])
                .filter(e => e);

            if (threadEmails.length === 0 && !emailsLoaded) {
                // Show loading indicator while emails load
                document.getElementById('email-list').innerHTML = `
                    <div style="padding: 48px; text-align: center; color: #5f6368;">
                        <p style="font-size: 14px;">Loading email content...</p>
                    </div>
                `;
                window.scrollTo(0, 0);

                // Start loading emails if not already loading
                loadEmailsFn();

                // Wait for emails to load then re-render
                await new Promise(resolve => {
                    const checkLoaded = setInterval(() => {
                        const loaded = thread.message_ids.some(id => emailStore[id]);
                        const fullyLoaded = isAllMailView ? allMailEmailsLoaded : notableEmailsLoaded;
                        if (loaded || fullyLoaded) {
                            clearInterval(checkLoaded);
                            resolve();
                        }
                    }, 100);
                });

                threadEmails = thread.message_ids
                    .map(id => emailStore[id])
                    .filter(e => e);
            }

            threadEmails.sort((a, b) => (a.date_parsed || '').localeCompare(b.date_parsed || ''));

            // If no emails loaded, show message
            if (threadEmails.length === 0) {
                detailActions.classList.remove('visible');
                document.getElementById('email-list').innerHTML = `
                    <div style="padding: 48px; text-align: center; color: #5f6368;">
                        <p style="font-size: 16px; margin-bottom: 8px;">Email content could not be loaded</p>
                        <p style="font-size: 13px;">Try refreshing the page or check your internet connection.</p>
                    </div>
                `;
                window.scrollTo(0, 0);
                return;
            }

            document.getElementById('email-list').innerHTML = threadEmails.map((e, idx) => {
                const notablePerson = getPersonForEmail(e.from_email);
                const isNotable = notablePerson !== null;
                const color = getAvatarColor(e.from_name || e.from_email || '');
                const initials = getInitials(e.from_name || e.from_email || '');
                const date = e.date_parsed ? new Date(e.date_parsed).toLocaleString() : '';
                const body = e.body || '(No content)';
                const isLong = body.length > 500;
                const isCollapsed = idx > 0;
                const snippet = body.substring(0, 100).replace(/\s+/g, ' ').trim();

                return `
                    <div class="email-card ${isNotable ? 'notable' : ''} ${isCollapsed ? 'collapsed' : ''}" data-email-id="${e.id}">
                        <div class="email-card-header">
                            <div class="email-avatar" style="background: ${color}">${initials}</div>
                            <div class="email-header-content">
                                <div class="email-from">
                                    <span class="sender-link" data-search="${escapeHtml(e.from_name || e.from_email || '')}">${escapeHtml(e.from_name || e.from_email || 'Unknown')}</span>
                                    ${e.from_email ? `<span class="email-address" data-email="${escapeHtml(e.from_email)}">&lt;${escapeHtml(e.from_email)}&gt;</span>` : ''}
                                </div>
                                <span class="email-snippet"> - ${escapeHtml(snippet)}${body.length > 100 ? '...' : ''}</span>
                                <div class="email-to">to cypherpunks@toad.com</div>
                            </div>
                            <div class="email-date">${date}</div>
                        </div>
                        <div class="email-body" id="body-${e.id}">${escapeHtml(body)}</div>
                    </div>
                `;
            }).join('');

            // Add click handlers for email addresses and sender names
            document.querySelectorAll('.email-address').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    filterByEmail(el.dataset.email);
                });
            });

            document.querySelectorAll('.sender-link').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (el.dataset.search) {
                        filterByEmail(el.dataset.search);
                    }
                });
            });

            // Add click handlers for collapsing/expanding email cards
            document.querySelectorAll('.email-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // Don't toggle if clicking on links or buttons
                    if (e.target.closest('.sender-link, .email-address, .expand-btn')) return;

                    if (card.classList.contains('collapsed')) {
                        card.classList.remove('collapsed');
                    } else {
                        // Allow collapsing any card except during text selection
                        if (window.getSelection().toString()) return;
                        card.classList.add('collapsed');
                    }
                });
            });

            window.scrollTo(0, 0);
        }

        // Filter by email address
        function filterByEmail(emailAddr) {
            searchInput.value = emailAddr;

            threadDetail.classList.remove('active');
            threadListView.classList.remove('hidden');

            activeFilterText.textContent = `Emails from ${emailAddr}`;
            activeFilter.classList.add('visible');

            applyFilters();
        }

        window.toggleBody = function(id) {
            const body = document.getElementById('body-' + id);
            const btn = body.nextElementSibling;
            if (body.classList.contains('collapsed')) {
                body.classList.remove('collapsed');
                btn.textContent = 'Show less';
            } else {
                body.classList.add('collapsed');
                btn.textContent = 'Show more';
            }
        };

        // Back button
        backBtn.addEventListener('click', () => {
            threadDetail.classList.remove('active');
            threadListView.classList.remove('hidden');
        });

        // Expand/Collapse all buttons
        expandAllBtn.addEventListener('click', () => {
            document.querySelectorAll('.email-card.collapsed').forEach(card => {
                card.classList.remove('collapsed');
            });
        });

        collapseAllBtn.addEventListener('click', () => {
            document.querySelectorAll('.email-card').forEach((card, idx) => {
                if (idx > 0) {
                    card.classList.add('collapsed');
                }
            });
        });

        // Thread navigation (prev/next)
        function updateThreadNav() {
            const total = filteredThreads.length;
            const current = currentThreadIndex + 1;
            threadNavInfo.textContent = `${current} of ${total}`;
            prevThreadBtn.disabled = currentThreadIndex <= 0;
            nextThreadBtn.disabled = currentThreadIndex >= total - 1;
        }

        function goToPrevThread() {
            if (currentThreadIndex > 0) {
                const prevThread = filteredThreads[currentThreadIndex - 1];
                showThread(prevThread.id);
            }
        }

        function goToNextThread() {
            if (currentThreadIndex < filteredThreads.length - 1) {
                const nextThread = filteredThreads[currentThreadIndex + 1];
                showThread(nextThread.id);
            }
        }

        prevThreadBtn.addEventListener('click', goToPrevThread);
        nextThreadBtn.addEventListener('click', goToNextThread);

        // Keyboard shortcuts for thread navigation
        document.addEventListener('keydown', (e) => {
            // Only handle if thread detail is visible
            if (!threadDetail.classList.contains('active')) return;
            // Don't handle if user is typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'j' || e.key === 'ArrowRight') {
                goToNextThread();
            } else if (e.key === 'k' || e.key === 'ArrowLeft') {
                goToPrevThread();
            } else if (e.key === 'Escape' || e.key === 'u') {
                threadDetail.classList.remove('active');
                threadListView.classList.remove('hidden');
            }
        });

        // Pagination
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderThreadList();
                window.scrollTo(0, 0);
            }
        });

        nextBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredThreads.length / perPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderThreadList();
                window.scrollTo(0, 0);
            }
        });

        // Filter handlers
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        });

        yearFilter.addEventListener('change', applyFilters);
        sortOrder.addEventListener('change', applyFilters);

        // Navigation handlers for Important/All Mail
        navImportant.addEventListener('click', () => switchView('important'));
        navAll.addEventListener('click', () => switchView('all'));

        function switchView(view) {
            const sameView = view === currentView;
            currentView = view;

            // If same view but person is selected, search is active, or detail view is open, handle it
            const detailOpen = threadDetail.classList.contains('active');
            if (sameView && !selectedPerson && !searchInput.value && !detailOpen) return;

            // Update nav styling
            navImportant.classList.toggle('active', view === 'important');
            navAll.classList.toggle('active', view === 'all');

            // Clear person filter, search, and year filter
            selectedPerson = null;
            searchInput.value = '';
            yearFilter.value = '';
            personListEl.querySelectorAll('.person-item').forEach(el => {
                el.classList.remove('active');
            });
            activeFilter.classList.remove('visible');

            // Close detail view if open
            threadDetail.classList.remove('active');
            threadListView.classList.remove('hidden');

            // Switch threads
            if (view === 'important') {
                threads = starredThreads;
                applyFilters();
            } else {
                if (allThreads.length === 0) {
                    threadListEl.innerHTML = '<li class="loading">Loading all mail...</li>';
                    loadAllMail().then((success) => {
                        if (success) {
                            threads = allThreads;
                            applyFilters();
                        } else {
                            threadListEl.innerHTML = '<li class="loading" style="color: #d93025;">Failed to load all mail</li>';
                        }
                    });
                    return;
                }
                threads = allThreads;
                applyFilters();
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (threadDetail.classList.contains('active') && e.key === 'Escape') {
                backBtn.click();
            }
        });

        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarClose = document.getElementById('sidebar-close');
        const mobileNavImportant = document.getElementById('mobile-nav-important');
        const mobileNavAll = document.getElementById('mobile-nav-all');
        const mobileNavLabels = document.getElementById('mobile-nav-labels');

        function openSidebar() {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('visible');
            document.body.style.overflow = '';
        }

        mobileMenuBtn.addEventListener('click', openSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        sidebarClose.addEventListener('click', closeSidebar);

        // Update mobile nav state when switching views
        function updateMobileNav(view) {
            mobileNavImportant.classList.toggle('active', view === 'important');
            mobileNavAll.classList.toggle('active', view === 'all');
            mobileNavLabels.classList.remove('active');
        }

        // Mobile nav handlers
        mobileNavImportant.addEventListener('click', () => {
            switchView('important');
            updateMobileNav('important');
        });

        mobileNavAll.addEventListener('click', () => {
            switchView('all');
            updateMobileNav('all');
        });

        mobileNavLabels.addEventListener('click', () => {
            openSidebar();
        });

        // Close sidebar when selecting a person on mobile
        const originalSelectPerson = selectPerson;
        selectPerson = function(personName) {
            originalSelectPerson(personName);
            closeSidebar();
            // Update mobile nav to show neither Important nor All Mail as active
            mobileNavImportant.classList.remove('active');
            mobileNavAll.classList.remove('active');
            mobileNavLabels.classList.add('active');
        };

        // Update mobile nav when clicking desktop nav
        const originalNavImportantClick = navImportant.onclick;
        navImportant.addEventListener('click', () => updateMobileNav('important'));
        navAll.addEventListener('click', () => updateMobileNav('all'));

        // Welcome popup
        const welcomeOverlay = document.getElementById('welcome-overlay');
        const welcomeBtn = document.getElementById('welcome-btn');

        function showWelcomePopup() {
            // Check if user has seen the popup before
            if (!localStorage.getItem('cypherpunk-welcome-seen')) {
                welcomeOverlay.classList.add('visible');
            }
        }

        function hideWelcomePopup() {
            welcomeOverlay.classList.remove('visible');
            localStorage.setItem('cypherpunk-welcome-seen', 'true');
        }

        welcomeBtn.addEventListener('click', hideWelcomePopup);
        welcomeOverlay.addEventListener('click', (e) => {
            if (e.target === welcomeOverlay) {
                hideWelcomePopup();
            }
        });

        // Initialize
        loadData();
        showWelcomePopup();
    </script>
</body>
</html>
